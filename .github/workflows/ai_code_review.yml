name: AI Code Review

on:
  pull_request:
    types: [opened, edited, synchronize]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PR_NUMBER: ${{ github.event.pull_request.number }}
  REPO_URL: ${{ github.event.repository.html_url }}

jobs:
  generate_code_review:
    runs-on: windows-latest
    
    steps:
    - name: Checkout AI Code Review repository
      uses: actions/checkout@v3
      with:
        repository: Stradek/gpt-code-review-py
        token: ${{ secrets.MY_PERSONAL_ACCESS_TOKEN }}
        path: ./gpt-code-review-py
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: 3.11
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r ./gpt-code-review-py/requirements.txt
    - name: Execute AI Code Review script
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        cd ./gpt-code-review-py/
        python ./src/gpt-code-review-py/main.py --pr_id ${{ env.PR_NUMBER }} --repo_url ${{ env.REPO_URL }} --output output.txt
    - name: Comment on PR with output from AI Code Review script
      shell: pwsh
      run: |
        $BODY = Get-Content -Path ./gpt-code-review-py/output.txt
        gh pr comment ${{ github.event.pull_request.number }} --body "$BODY"
